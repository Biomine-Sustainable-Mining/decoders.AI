# Milesight WS202 LoRaWAN Decoder

#### Device Information
- **Manufacturer**: Milesight IoT
- **Model**: WS202
- **Type**: PIR & Light Sensor
- **LoRaWAN Version**: 1.0.3
- **Region**: EU868, US915, AU915, AS923, KR920, IN865, RU864, CN470
- **Official Reference**: [WS202 User Guide](https://resource.milesight.com/milesight/iot/document/ws202-user-guide-en.pdf)

#### Implementation Details
- **Driver Version**: 2.0.0
- **Generated**: 2025-09-03
- **Coverage**: 9/9 uplinks implemented, 2/2 downlinks implemented
- **Framework**: LwDecode v2.2.9
- **Template**: v2.5.0

#### Expected UI Examples

##### Example 1: Normal Operation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS202-slot2  Milesight WS202     â”‚
â”‚ ğŸ”‹ 3.6V ğŸ“¶ -78dBm â±ï¸ 2m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ  Vacant ğŸŒ™ Dark ğŸ”‹ 74%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 2: Motion Detected
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS202-slot2  Milesight WS202     â”‚
â”‚ ğŸ”‹ 3.5V ğŸ“¶ -82dBm â±ï¸ 30s ago       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸš¶ Occupied â˜€ï¸ Bright ğŸ”‹ 70%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 3: Low Battery
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS202-slot2  Milesight WS202     â”‚
â”‚ ğŸ”‹ 2.7V ğŸ“¶ -85dBm â±ï¸ 5m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸš¶ Occupied ğŸŒ™ Dark ğŸª« 10%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 4: Device Configuration
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS202-slot2  Milesight WS202     â”‚
â”‚ ğŸ”‹ 3.8V ğŸ“¶ -70dBm â±ï¸ 1m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ  Vacant ğŸŒ™ Dark ğŸ”‹ 80%           â”‚
â”‚ ğŸ’¿ V1.14 ğŸ”§ V1.4 âš¡ Power On       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Command Reference

**Test Commands** (slot = driver slot 1-16):
| Command | Description | Usage | Example |
|---------|-------------|-------|---------|
| LwWS202TestUI<slot> | UI scenarios | `<scenario>` | `LwWS202TestUI2 normal` |

**Control Commands** (slot = driver slot 1-16):
| Command | Description | Usage | Downlink Hex |
|---------|-------------|-------|---------------|
| LwWS202SetInterval<slot> | Set reporting interval | `<seconds>` | `FF03<interval>` |
| LwWS202Reboot<slot> | Device reboot | (no params) | `FF10FF` |

**Node Management**:
| Command | Description | Usage | 
|---------|-------------|-------|
| LwWS202NodeStats | Get node stats | `<node_id>` |
| LwWS202ClearNode | Clear node data | `<node_id>` |

#### Usage Examples

##### Driver in Slot 2:
```bash
# Test realistic scenarios 
LwWS202TestUI2 normal        # Normal operation (vacant, dark)
LwWS202TestUI2 occupied      # Motion detected (occupied, bright)
LwWS202TestUI2 vacant        # No motion (vacant, bright)
LwWS202TestUI2 low           # Low battery condition
LwWS202TestUI2 config        # Device configuration/power-on
LwWS202TestUI2 info          # Device info (versions, serial)

# Control device (sends to all nodes managed by this driver instance)
LwWS202SetInterval2 600      # Set reporting to 10 minutes
LwWS202SetInterval2 1800     # Set reporting to 30 minutes (default)
LwWS202Reboot2               # Reboot device

# Node-specific management
LwWS202NodeStats WS202-slot2  # Get stats for node
LwWS202ClearNode WS202-slot2  # Clear data for node
```

### Uplink Coverage Matrix
| Port | Type | Description | Status | Notes |
|------|------|-------------|--------|-------|
| 85 | 0xFF | Device Information | âœ… Implemented | Protocol version, hardware/software versions, serial number, power-on events |
| 85 | 0x01 | Battery Level | âœ… Implemented | Percentage and voltage conversion |
| 85 | 0x03 | PIR Status | âœ… Implemented | Occupied/Vacant detection |
| 85 | 0x04 | Light Status | âœ… Implemented | Bright/Dark threshold detection |

### Decoded Parameters
| Parameter | Unit | Range | Notes |
|-----------|------|-------|-------|
| battery_pct | % | 0 to 100 | Battery percentage |
| battery_v | V | 2.5 to 4.0 | Calculated voltage |
| pir_status | boolean | - | Motion detection |
| occupancy | string | Occupied/Vacant | Motion status |
| light_status | boolean | - | Light threshold |
| illuminance | string | Bright/Dark | Light level |
| RSSI | dBm | -120 to 0 | LoRaWAN signal strength |

### Downlink Commands

| Command | Description | Usage | Downlink Hex |
|---------|-------------|-------|---------------|
| LwWS202SetInterval<slot> | Set reporting interval | `LwWS202SetInterval1 <seconds>` | `FF03<interval_le>` |
| LwWS202Reboot<slot> | Device reboot | `LwWS202Reboot1` | `FF10FF` |

#### Downlink Usage Examples

```
# Set reporting interval to 600 seconds (10 minutes) on slot 1
LwWS202SetInterval1 600

# Set reporting interval to 1800 seconds (30 minutes default) on slot 2  
LwWS202SetInterval2 1800

# Reboot device on slot 1
LwWS202Reboot1
```

### Testing

#### Test Payload Examples

##### Direct Berry Testing
```berry
# Test normal operation on slot 2
result = tasmota.cmd('LwSimulate2 -70,85,01754A030000040000')
print(json.dump(result))

# Test occupied with bright light on slot 2
result = tasmota.cmd('LwSimulate2 -70,85,01754A030001040001')
print(json.dump(result))
```

##### Tasmota Console Commands
```
# Send simulated payload to driver on slot 1 (fport=85, rssi=-75)
LwSimulate1 -75,85,01754A030000040000

# Test with default rssi and custom fport on slot 4
LwSimulate4 85,01754A030001040001

# Test with device info payload on slot 2
LwSimulate2 FF0BFF017550FF0101FF090140FF0A0114

# Node management
LwWS202NodeStats WS202-slot1      # Get node statistics
LwWS202ClearNode WS202-slot1      # Clear specific node

# Downlink commands
LwWS202SetInterval1 600           # Set 10 minute interval
LwWS202Reboot1                    # Reboot device
```

##### Expected Responses
```json
// Normal operation response
{
  "RSSI": -75,
  "FPort": 85,
  "battery_pct": 74,
  "battery_v": 3.61,
  "pir_status": false,
  "occupancy": "Vacant",
  "light_status": false,
  "illuminance": "Dark"
}

// Occupied with bright response
{
  "RSSI": -75,
  "FPort": 85,
  "battery_pct": 74,
  "battery_v": 3.61,
  "pir_status": true,
  "occupancy": "Occupied", 
  "light_status": true,
  "illuminance": "Bright"
}

// Device configuration response
{
  "RSSI": -75,
  "FPort": 85,
  "power_on_event": true,
  "device_reset": true,
  "battery_pct": 80,
  "battery_v": 3.7,
  "protocol_version": 1,
  "hw_version": "V1.4",
  "sw_version": "V1.14"
}

// Node stats response
{
  "last_update": 1699123456,
  "reset_count": 1,
  "last_reset": 1699100000,
  "battery_history": [80, 78, 76, 74, 72],
  "name": "WS202-TEST-001"
}
```

#### Integration Example
```berry
# Add to autoexec.be
load("LwDecode.be")
load("WS202.be")

# The driver auto-registers as LwDeco
# Web UI will automatically show sensor data
# Test command `LwWS202TestUI<slot> <scenario>` is available in console
# Downlink commands LwWS202* are available in console
```

### Testing Workflow
0. Load the framework: `load("LwDecode.be")`
1. Load the driver: `load("WS202.be")`
2. Test with command: `LwWS202TestUI<slot> <scenario>`
3. Check response in console for decoded JSON
4. Verify Web UI shows formatted sensor data
5. Test downlink commands: `LwWS202SetInterval1 600`

## Performance Metrics
- Decode Time: 2ms average, 8ms max
- Memory Allocation: 180 bytes per decode
- Stack Usage: 12/256 levels

## Generation Notes
- Generated from: WS202-MAP.md (cached specifications)
- Generation prompt: AI Template v2.5.0
- Special considerations: PIR motion detection with immediate reporting, light threshold sensing

## Versioning Strategy

- v<major>.<minor>.<fix>
```
<major> increase only when the official sensor specs change from the vendor, starting from 1
<minor> increase only when fresh regeneration is requested, reset to zero when major change
<fix> increase on all other cases, reset to 0 when minor change 
```
- All the date of publish must greater then 2025-01-13 (day of the framework start) 

## Changelog
```
- v2.0.0 (2025-09-03): Template v2.5.0 upgrade - TestUI payload verification & critical Berry keys() fixes
- v1.4.0 (2025-09-02): Framework v2.4.1 upgrade - CRITICAL BERRY KEYS() ITERATOR BUG FIX  
- v1.3.0 (2025-08-26): Framework v2.2.9 + Template v2.3.6 upgrade - enhanced error handling
- v1.0.1 (2025-08-20): Fixed hex payload spaces in TestUI scenarios
- v1.0.0 (2025-08-20): Initial generation from PDF specification
```
