# Milesight WS301 LoRaWAN Decoder

#### Device Information
- **Manufacturer**: Milesight IoT
- **Model**: WS301
- **Type**: Magnetic Contact Switch
- **LoRaWAN Version**: 1.0.3
- **Region**: EU868, US915, AU915, CN470
- **Official Reference**: [WS301 User Guide](https://resource.milesight.com/milesight/iot/document/ws301-user-guide-en.pdf)

#### Implementation Details
- **Driver Version**: 2.0.0
- **Generated**: 2025-09-03
- **Coverage**: 10/10 uplinks implemented, 2/2 downlinks implemented
- **Framework**: LwDecode v2.2.9
- **Template**: v2.5.0

#### Expected UI Examples

##### Example 1: Door Closed (Normal)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS301-slot2  Milesight WS301     â”‚
â”‚ ğŸ”‹ 3.6V ğŸ“¶ -78dBm â±ï¸ 2m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”’ Closed âœ… Installed ğŸ”‹ 74%      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 2: Door Open
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS301-slot2  Milesight WS301     â”‚
â”‚ ğŸ”‹ 3.5V ğŸ“¶ -82dBm â±ï¸ 30s ago       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”“ Open âœ… Installed ğŸ”‹ 70%        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 3: Tamper Detection
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS301-slot2  Milesight WS301     â”‚
â”‚ ğŸ”‹ 3.4V ğŸ“¶ -85dBm â±ï¸ 1m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”’ Closed âš ï¸ Tamper ğŸ”‹ 65%         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 4: Low Battery
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS301-slot2  Milesight WS301     â”‚
â”‚ ğŸ”‹ 2.6V ğŸ“¶ -88dBm â±ï¸ 5m ago        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”“ Open âœ… Installed ğŸª« 10%        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##### Example 5: Device Configuration
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  WS301-slot2  Milesight WS301     â”‚
â”‚ ğŸ”‹ 3.6V ğŸ“¶ -75dBm â±ï¸ 30s ago       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”’ Closed âœ… Installed ğŸ”‹ 74%      â”‚
â”‚ ğŸ’¿ V1.14 ğŸ”§ V1.4 âš¡ Power On       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Command Reference

**Test Commands** (slot = driver slot 1-16):
| Command | Description | Usage | Example |
|---------|-------------|-------|---------|
| LwWS301TestUI<slot> | UI scenarios | `<scenario>` | `LwWS301TestUI2 normal` |

**Control Commands** (slot = driver slot 1-16):
| Command | Description | Usage | Downlink Hex |
|---------|-------------|-------|---------------|
| LwWS301SetInterval<slot> | Set reporting interval | `<seconds>` | `FF03<interval>` |
| LwWS301Reboot<slot> | Device reboot | (no params) | `FF10FF` |

**Node Management**:
| Command | Description | Usage | 
|---------|-------------|-------|
| LwWS301NodeStats | Get node stats | `<node_id>` |
| LwWS301ClearNode | Clear node data | `<node_id>` |

#### Usage Examples

##### Driver in Slot 2:
```bash
# Test realistic scenarios 
LwWS301TestUI2 normal        # Door closed, installed, normal battery
LwWS301TestUI2 open          # Door open, installed
LwWS301TestUI2 tamper        # Tamper/uninstalled detection
LwWS301TestUI2 low           # Low battery condition
LwWS301TestUI2 config        # Device configuration/power-on
LwWS301TestUI2 info          # Device info (versions, serial)

# Control device (sends to all nodes managed by this driver instance)
LwWS301SetInterval2 600      # Set reporting to 10 minutes
LwWS301SetInterval2 1800     # Set reporting to 30 minutes
LwWS301Reboot2               # Reboot device

# Node-specific management
LwWS301NodeStats WS301-slot2  # Get stats for node
LwWS301ClearNode WS301-slot2  # Clear data for node
```

### Uplink Coverage Matrix
| Port | Type | Description | Status | Notes |
|------|------|-------------|--------|-------|
| 85 | 0xFF | Device Information | âœ… Implemented | Protocol version, hardware/software versions, serial number, power-on events |
| 85 | 0x01 | Battery Level | âœ… Implemented | Percentage and voltage conversion |
| 85 | 0x03 | Magnet Status | âœ… Implemented | Door open/closed detection |
| 85 | 0x04 | Tamper Status | âœ… Implemented | Installation/tamper detection |

### Decoded Parameters
| Parameter | Unit | Range | Notes |
|-----------|------|-------|-------|
| battery_level | % | 0 to 100 | Battery percentage |
| battery_v | V | 2.5 to 3.6 | Calculated voltage |
| door_state | boolean | - | Magnetic contact |
| door_open | boolean | - | Door status |
| tamper_detected | boolean | - | Tamper detection |
| device_installed | boolean | - | Installation status |
| RSSI | dBm | -120 to 0 | LoRaWAN signal strength |

### Downlink Commands

| Command | Description | Usage | Downlink Hex |
|---------|-------------|-------|---------------|
| LwWS301SetInterval<slot> | Set reporting interval | `LwWS301SetInterval1 <seconds>` | `FF03<interval_le>` |
| LwWS301Reboot<slot> | Device reboot | `LwWS301Reboot1` | `FF10FF` |

#### Downlink Usage Examples

```
# Set reporting interval to 600 seconds (10 minutes) on slot 1
LwWS301SetInterval1 600

# Set reporting interval to 1800 seconds (30 minutes) on slot 2  
LwWS301SetInterval2 1800

# Reboot device on slot 1
LwWS301Reboot1
```

### Testing

#### Test Payload Examples

##### Direct Berry Testing
```berry
# Test normal operation on slot 2
result = tasmota.cmd('LwSimulate2 -70,85,01754A030000040000')
print(json.dump(result))

# Test door open on slot 2
result = tasmota.cmd('LwSimulate2 -70,85,01754A030001040000')
print(json.dump(result))
```

##### Tasmota Console Commands
```
# Send simulated payload to driver on slot 1 (fport=85, rssi=-75)
LwSimulate1 -75,85,01754A030000040000

# Test with door open payload on slot 4
LwSimulate4 85,01754A030001040000

# Test with tamper detection on slot 2
LwSimulate2 01754A030000040001

# Node management
LwWS301NodeStats WS301-slot1      # Get node statistics
LwWS301ClearNode WS301-slot1      # Clear specific node

# Downlink commands
LwWS301SetInterval1 600           # Set 10 minute interval
LwWS301Reboot1                    # Reboot device
```

##### Expected Responses
```json
// Normal operation response (door closed)
{
  "RSSI": -75,
  "FPort": 85,
  "battery_level": 74,
  "battery_v": 3.31,
  "door_state": 0,
  "door_open": false,
  "tamper_detected": false,
  "device_installed": true
}

// Door open response
{
  "RSSI": -75,
  "FPort": 85,
  "battery_level": 74,
  "battery_v": 3.31,
  "door_state": 1,
  "door_open": true,
  "tamper_detected": false,
  "device_installed": true
}

// Device configuration response
{
  "RSSI": -75,
  "FPort": 85,
  "power_on_event": true,
  "device_reset": true,
  "battery_level": 74,
  "battery_v": 3.31,
  "protocol_version": 1,
  "hw_version": "V1.4",
  "sw_version": "V1.14"
}

// Node stats response
{
  "last_update": 1699123456,
  "reset_count": 1,
  "last_reset": 1699100000,
  "battery_history": [78, 76, 74, 72, 70],
  "door_change_count": 15,
  "last_door_change": 1699120000,
  "tamper_count": 0,
  "last_tamper": 0,
  "name": "WS301-TEST-001"
}
```

#### Integration Example
```berry
# Add to autoexec.be
load("LwDecode.be")
load("WS301.be")

# The driver auto-registers as LwDeco
# Web UI will automatically show sensor data
# Test command `LwWS301TestUI<slot> <scenario>` is available in console
# Downlink commands LwWS301* are available in console
```

### Testing Workflow
0. Load the framework: `load("LwDecode.be")`
1. Load the driver: `load("WS301.be")`
2. Test with command: `LwWS301TestUI<slot> <scenario>`
3. Check response in console for decoded JSON
4. Verify Web UI shows formatted sensor data
5. Test downlink commands: `LwWS301SetInterval1 600`

## Performance Metrics
- Decode Time: 3ms average, 10ms max
- Memory Allocation: 220 bytes per decode
- Stack Usage: 15/256 levels

## Generation Notes
- Generated from: WS301-MAP.md (cached specifications)
- Generation prompt: AI Template v2.5.0
- Special considerations: Magnetic contact switch with tamper detection and door state tracking

## Versioning Strategy

- v<major>.<minor>.<fix>
```
<major> increase only when the official sensor specs change from the vendor, starting from 1
<minor> increase only when fresh regeneration is requested, reset to zero when major change
<fix> increase on all other cases, reset to 0 when minor change 
```
- All the date of publish must greater then 2025-01-13 (day of the framework start) 

## Changelog
```
- v2.0.0 (2025-09-03): Template v2.5.0 upgrade - TestUI payload verification & critical Berry keys() fixes
- v1.5.0 (2025-09-02): Framework v2.4.1 upgrade - CRITICAL BERRY KEYS() ITERATOR BUG FIX  
- v1.4.0 (2025-08-26): Framework v2.2.9 + Template v2.3.6 upgrade - enhanced error handling
- v1.3.0 (2025-08-20): Complete regeneration with framework v2.2.6
- v1.2.0 (2025-08-20): Enhanced door state tracking and security features
- v1.1.0 (2025-08-16): Added comprehensive test scenarios
- v1.0.0 (2025-08-15): Initial generation from PDF specification
```
